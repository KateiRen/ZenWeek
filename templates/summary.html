
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
    <title>Wochen√ºbersicht</title>
  </head>
  <body class="summary-page">
    <!-- Fixed Header -->
    <div class="fixed-header">
      <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="d-flex align-items-center">
            <a href="/" title="Zur Startseite">
              <img src="{{ url_for('static', filename='ZenWeekLogo.png') }}" alt="ZenWeek Logo" class="zenweek-logo">
            </a>
            <h1 class="mb-0">Wochen√ºbersicht</h1>
          </div>
          <div class="d-flex align-items-center">
            <a href="/" class="btn btn-outline-secondary btn-sm ms-2" title="Zur√ºck zum Wochenplaner">
              <i class="bi bi-calendar-week summary-chart-icon"></i>
            </a>
          </div>
        </div>
      </div>
    </div> <!-- End of fixed-header -->
    
    <div class="container mt-4">
      <h2>Offene & √úberf√§llige Aufgaben ({{ open_tasks|length }})</h2>
      {% if open_tasks %}
      <div class="mb-4">
        <table class="table table-bordered align-middle w-100 summary-table-fit">
    <style>
      /* Make summary table fit the window and avoid horizontal scroll */
      .summary-table-fit {
        table-layout: auto;
        width: 100%;
        word-break: break-word;
      }
      .summary-table-fit td, .summary-table-fit th {
        white-space: normal;
        word-break: break-word;
        max-width: 220px;
      }
      /* Action columns: snap to content size */
      .summary-table-fit th.action-col {
        min-width: 90px;
        max-width: 140px;
        white-space: normal;
        text-align: center;
        padding-left: 0.25rem;
        padding-right: 0.25rem;
        word-break: break-word;
      }
      .summary-table-fit td.action-col {
        width: 1%;
        min-width: 44px;
        max-width: 60px;
        white-space: nowrap;
        text-align: center;
        padding-left: 0.25rem;
        padding-right: 0.25rem;
      }
      .summary-table-fit td.action-col button {
        min-width: 32px;
        padding-left: 0;
        padding-right: 0;
      }
      @media (max-width: 768px) {
        .summary-table-fit td, .summary-table-fit th {
          max-width: 120px;
        }
      }
      /* Chart styling to match table width */
      .summary-chart-fit {
        width: 100%;
      }
      .summary-chart-fit canvas {
        width: 100% !important;
        max-width: 100% !important;
      }
    </style>
          <thead class="table-light">
            <tr>
              <th>Aufgabe</th>
              <th>Woche</th>
              <th>Status</th>
              <th class="text-center action-col">Erledigt</th>
              <th class="text-center action-col">Zur aktuellen Woche</th>
              <th class="text-center action-col">Springe zur Woche</th>
              <th class="text-center action-col">L√∂schen</th>
            </tr>
          </thead>
          <tbody>
            {% for task in open_tasks %}
            <tr>
              <td>
                {{ task.taskname }}
                {% if task.url %}
                  <a href="{{ task.url }}" target="_blank" rel="noopener" class="ms-2" title="Zur Webseite">
                    <i class="bi bi-link-45deg"></i>
                  </a>
                {% endif %}
              </td>
              <td>KW{{ task.week }} {{ task.year }}</td>
              <td>
                {% if task.is_overdue %}
                  <span class="badge bg-danger">√úberf√§llig</span>
                {% else %}
                  <span class="badge bg-secondary">Offen</span>
                {% endif %}
              </td>
              <td class="text-center action-col">
                <button class="btn btn-success btn-sm complete-task-btn" title="Als erledigt markieren" data-taskid="{{ task.id }}">
                  <i class="bi bi-check-lg"></i>
                </button>
              </td>
              <td class="text-center action-col">
                <button class="btn btn-primary btn-sm move-task-btn" title="In die aktuelle Woche verschieben" data-taskid="{{ task.id }}">
                  <i class="bi bi-arrow-right"></i>
                </button>
              </td>
              <td class="text-center action-col">
                <a class="btn btn-outline-secondary btn-sm" title="Zur Woche springen" href="/?year={{ task.year }}&week={{ task.week }}">
                  <i class="bi bi-arrow-bar-right"></i>
                </a>
              </td>
              <td class="text-center action-col">
                <button class="btn btn-danger btn-sm delete-task-btn" title="Aufgabe l√∂schen" data-taskid="{{ task.id }}">
                  <i class="bi bi-trash"></i>
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="alert alert-success">Keine offenen Aufgaben üéâ</div>
      {% endif %}
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <script>
      // Button handlers (AJAX logic)
      document.addEventListener('DOMContentLoaded', function() {
        // Mark as completed
        document.querySelectorAll('.complete-task-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const taskId = this.getAttribute('data-taskid');
            fetch(`/editTask?taskid=${taskId}&action=done`)
              .then(resp => resp.json())
              .then(data => location.reload())
              .catch(() => alert('Fehler beim Abschlie√üen der Aufgabe.'));
          });
        });
        // Move to current week
        document.querySelectorAll('.move-task-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const taskId = this.getAttribute('data-taskid');
            // Get current year/week from summary page context (server time)
            fetch('/get_current_year_week')
              .then(resp => resp.json())
              .then(({year, week}) => {
                fetch(`/moveTask?taskid=${taskId}&year=${year}&week=${week}`)
                  .then(resp => resp.json())
                  .then(data => location.reload())
                  .catch(() => alert('Fehler beim Verschieben der Aufgabe.'));
              });
          });
        });
        // Delete task
        document.querySelectorAll('.delete-task-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const taskId = this.getAttribute('data-taskid');
            fetch(`/deleteTask?taskid=${taskId}`)
              .then(resp => resp.json())
              .then(data => location.reload())
              .catch(() => alert('Fehler beim L√∂schen der Aufgabe.'));
          });
        });
      });
    </script>
      <h3>Offene Aufgaben nach Jahr</h3>
      <div class="summary-chart-fit" style="max-width:600px; margin:auto;">
        <canvas id="yearlyOpenTasksChart" height="220"></canvas>
      </div>
      <h3>Wochenstatistik</h3>
      <canvas id="weeklyChart" height="120"></canvas>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script id="weekly-data-json" type="application/json">{{ weekly_data|tojson }}</script>
    <script id="year-summary-json" type="application/json">{{ year_summary|tojson }}</script>
    <script>
      // Weekly chart - Stacked bar chart (v2) with clickable bars
      try {
        const ctx = document.getElementById('weeklyChart').getContext('2d');
        const weeklyData = JSON.parse(document.getElementById('weekly-data-json').textContent);
        // Calculate remaining (open) tasks for each week
        const remainingTasks = weeklyData.total.map((total, index) => {
          const completed = weeklyData.completed[index] || 0;
          return Math.max(0, total - completed);
        });
        // Parse year/week from label (format: KW{week} {year})
        function parseYearWeek(label) {
          const match = label.match(/KW(\d+)\s+(\d{4})/);
          if (match) {
            return { week: parseInt(match[1], 10), year: parseInt(match[2], 10) };
          }
          return null;
        }
        const weeklyChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: weeklyData.labels,
            datasets: [
              {
                label: 'Erledigte Aufgaben',
                data: weeklyData.completed,
                backgroundColor: '#28a745',
                borderColor: '#1e7e34',
                borderWidth: 1
              },
              {
                label: 'Offene Aufgaben',
                data: remainingTasks,
                backgroundColor: '#dc3545',
                borderColor: '#c82333',
                borderWidth: 1
              }
            ]
          },
          options: {
            responsive: true,
            interaction: {
              intersect: false,
            },
            plugins: { 
              legend: { 
                position: 'top',
                labels: {
                  usePointStyle: true
                }
              },
              tooltip: {
                mode: 'index',
                callbacks: {
                  footer: function(tooltipItems) {
                    let total = 0;
                    tooltipItems.forEach(function(tooltipItem) {
                      total += tooltipItem.parsed.y;
                    });
                    return 'Gesamt: ' + total;
                  }
                }
              }
            },
            scales: { 
              x: {
                stacked: true
              },
              y: { 
                beginAtZero: true,
                stacked: true,
                ticks: {
                  precision: 0
                }
              }
            },
            // Add onClick handler for bar navigation
            onClick: function(evt, elements) {
              if (elements && elements.length > 0) {
                const idx = elements[0].index;
                const label = this.data.labels[idx];
                const yw = parseYearWeek(label);
                if (yw) {
                  window.location.href = `/?year=${yw.year}&week=${yw.week}`;
                }
              }
            }
          }
        });
      } catch (error) {
        console.log('Error creating weekly chart:', error);
      }

      // Yearly open tasks chart
      try {
        const yearSummary = JSON.parse(document.getElementById('year-summary-json').textContent);
        const yearLabels = yearSummary.map(row => row.year);
        const yearCounts = yearSummary.map(row => row.count);
        const ctxYear = document.getElementById('yearlyOpenTasksChart').getContext('2d');
        new Chart(ctxYear, {
          type: 'bar',
          data: {
            labels: yearLabels,
            datasets: [
              {
                label: 'Offene Aufgaben',
                data: yearCounts,
                backgroundColor: 'rgba(255, 193, 7, 0.8)',
                borderColor: 'rgba(255, 193, 7, 1)',
                borderWidth: 1
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 2.5, // width/height ratio (e.g., 600/220)
            plugins: { 
              legend: { display: false },
              tooltip: {
                mode: 'index'
              }
            },
            scales: { 
              y: { 
                beginAtZero: true,
                ticks: {
                  precision: 0
                }
              }
            }
          }
        });
      } catch (error) {
        console.log('Error creating yearly chart:', error);
      }
    </script>
  </body>
</html>
